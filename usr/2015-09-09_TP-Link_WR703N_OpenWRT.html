<!DOCTYPE html>
<html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<head>
<title>TP-Link WR703N 使用 OpenWRT 记录</title>
</head>
<body>

<xmp theme="united" style="display:none;">

本文更新时间: `2015-9-16`

### 设备信息
- 当前软件版本： 3.12.11 Build 110926 Rel.40632n
- 当前硬件版本： WR703N v1 00000000 

### 关于 OpenWRT Rom 版本
- 很多版本，以下列几个最新的版本
  - AA:Attitude Adjustment (12.09 final) 稳定版  Left:880K/1.1M
  - BB:BarrierBreaker 14.07 最近的稳定版         Left:404K/640K
  - CC:Chaos Calmer 15.05-rc3  测试阶段          Left:292K/512K   空间不足以装ext4模块
- 自己一开始没注意版本，使用的是AA版
- 现升级到BB版，发现lucci的界面在IE6上显示很烂, AA虽烂，可能显示
- 现在，试过了BB.CC版，发现还是AA版靠谱一点,BB其实勉强还可以安装,CC连ext4都没空间装，其他模块就别想了

### 刷 Rom
- **从TP-link升级** 使用 带 factory 的rom
  - 注意：升级时请选择与当前硬件版本一致的软件。升级过程不能关闭路由器电源，否则将导致路由器损坏而无法使用。升级过程约1至2分钟，当升级结束后，路由器将会自动重新启动。 
  - 选择的Rom版本是AA
  - 下载Rom: http://downloads.openwrt.org/attitude_adjustment/12.09/ar71xx/generic/openwrt-ar71xx-generic-tl-wr703n-v1-squashfs-factory.bin
  - 重命名为: openwrt.bin 然后在浏览器界面中选择升级bin
- **从openwrt升级**，使用带 sysupgrade 的rom，使用 sysupgrade /tmp/xx.bin 的方式

### 初始化
- 参考: http://www.jb51.net/network/113081.html
- 将网线插入LAN/Wan口，另一端插入电脑
- 命令行里运行: telnet 192.168.1.1
- passwd命令修改root密码，它会关闭telnet，之后只能使用更安全一点的ssh登录
- putty 连接 192.168.1.1 , 用户名为root,密码就是刚设置的那个，`这个密码也是后面网页登录的密码`

### 设置 (注释一般是在该行的头部添加#号)
- vi /etc/config/wireless
````config
# option disabled 1   # 注释掉这行，就是打开wifi
````

- vi /etc/config/network
````config
# option ifname 'eth0'  # 注释掉Lan段中的这行
````
  - 然后增加wan接口，如果你上级网络是DHCP的，则文件的末尾添加：
````config
config interface 'wan'
    option ifname 'eth0'
    option proto 'dhcp'
````

### 安装软件(分号后是注释，不要当命令输入进去了)
- opkg update  ; 每次重启后如果要装软件，都要运行这个以刷新软件列表
- opkg install kmod-usb-storage block-mount kmod-fs-ext4       ; 安装usb存储设备驱动and vfat
- opkg install kmod-fs-vfat kmod-nls-cp437 kmod-nls-iso8859-1  ; 这个是fat/fat32驱动
- opkg install kmod-nls-utf8 luci-i18n-chinese ; luci中文 未测试
- opkg install vsftpd  ; ftp 服务端
- opkg install wget-nossl netcat tinyproxy msmtp-nossl     ; 一些工具

### USB 做为根文件系统，目的提高存储区域，也就是'硬盘'
- U盘格式化Ext4时推荐: mkfs.ext4 -O "^has_journal"
- 挂载选项去掉sync，提高性能

- 下面的命令目的是将当前系统复制到新分的根分区
  - mkdir /tmp/root              ; 在/tmp目录下创建一个临时目录，用于放置系统镜像
  - mount /dev/sda1 /mnt         ; 将/dev/sda1 挂载到/mnt目录下
  - mount -o bind / /tmp/root    ; 将根目录"/"制作镜像，并将其挂载到“/tmp/root”下
  - cp /tmp/root/* /mnt -a       ; 将/tmp/root/ 目录下的所有内容复制到/mnt下
  - umount /tmp/root             ; 解除挂载 /tmp/root

- vi /etc/config/fstab  ; 内容如下

````config
config global automount
  option from_fstab 1
  option anon_mount 1

config global autoswap
  option from_fstab 1
  option anon_swap 0

config mount
  option target /aaa
  option device /dev/sda1
  option fstype ext4
  option options rw
  option enabled 1
  option enabled_fsck 0

config mount 
  option device /dev/sda3
  option fstype ext4
  option options rw
  option enabled 1
  option enabled_fsck 0
  option is_rootfs 1

config swap
  option device    /dev/sda3
  option enabled  1
````

- /etc/init.d/fstab enable  ; init.d下面的脚本一般都可以 enable(系统启动时启动),disable,start,stop,restart
- reboot

### 定时任务
- crontab -e
- 然后输入: `*/1 * * * * /aaa/bin/xxxx`

### PATH环境变量添加，只在ssh下有效，crond无效哦
- vi /etc/profile
- 修改下面这行: `export PATH=/bin:/sbin:/xxx:/usr/bin:/usr/sbin`

### 2015-9-9: 关于计划任务失效的问题
- 缘起: 最近发现用来发送ip信息的定时脚本没有执行，试遍了各种方法，终于找到原因了
  - 原因: 自己将U盘的一个目录添加到/etc/profile 中的PATH变量中，这个目录执行时就不用输入完整路径了（自以为的），定时执行的脚本也放到这个目录，在ssh时执行是没有问题的，PATH环境变量显示正常，但是crond的PATH环境变量不一定是修改过的哦，所以它执行的时候找不到脚本和需要的命令，所以也就没有执行，在/bin中创建一个脚本并加入定时任务后证实了最坏的假定，果然其中不包括自定义的目录，蛋疼，这下知道怎么改了
- 解决方法1: 定时列表和其中以来的程序放到 crond的PATH环境变量包含的目录中，也就是/sbin:/usr/sbin:/bin:/usr/bin
- 解决方法2: 将脚本及程序创建软链接到 crond的PATH环境变量包含的目录中: ln -s /aaaa/bin/xxxx /sbin/xxxx
- 解决方法3: crontab -e 修改定时任务，写上脚本的完整路径，脚本中依赖的程序写完整路径
- 待提高的方法: 找到openwrt中crond的PATH环境变量是由谁控制的，修改之

### 变砖修复记
- 原因: 设置不当，导致连不上wifi和网线
- 参考下面的帖子搞定的 http://www.right.com.cn/forum/thread-77072-1-1.html
  - 1、准备一个粗一点的牙签；
  - 2、把牙签预先对准复位键；
  - 3、上电，同时快速、连续按复位键，持续大约20秒；
  - 4、观察指示灯是否进入快速闪动，频率在每秒10次左右。
- 连接网线，PC网卡设置固定IP，ping通，阿弥陀佛，telnet之
  - 5、接着输入“firstboot”，让系统回归到第一次你正常使用的openwrt版本。
  - 6、接着输入“passwd”，设定你自己的密码，要输两次，核对校验的。
- 搞定收工


### 2015-9-16: 命令行发送邮件，亲测可用
- 参考: http://blog.chinaunix.net/uid-29616823-id-4406559.html
- opkg install msmtp-nossl
- vi /etc/msmtprc
  - 修改host那行为下面的设置 
  ````config
# The SMTP smarthost.
host smtp.163.com
from fromEmailAddress@163.com
auth login
user fromEmailAddress@163.com
password yourpassword
````
- 发送邮件时:
  - echo -e "to:ToEmailAddress@163.com\nsubject:test\n\nthis a test\n" | msmtp -t


</xmp>

<script src="http://strapdownjs.com/v/0.2/strapdown.js"></script>

<div class="AD" align="center"><script src="http://s14.cnzz.com/stat.php?id=3279032&web_id=3279032&online=1&show=line" language="JavaScript"></script></div>

</body>
</html>

